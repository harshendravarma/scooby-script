"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var react_1 = require("react");
var arraysAreEqual_1 = require("./helpers/arraysAreEqual");
var getActiveModifierKeys_1 = require("./helpers/getActiveModifierKeys");
var getHotkeysArray_1 = require("./helpers/getHotkeysArray");
var isSameSet_1 = require("./helpers/isSameSet");
var mapModifierKeys_1 = require("./helpers/mapModifierKeys");
var modifierKeyPressed_1 = require("./helpers/modifierKeyPressed");
var tail_1 = require("./helpers/tail");
var takeUntilLast_1 = require("./helpers/takeUntilLast");
var ignoreKeydownEvent_1 = require("./helpers/ignoreKeydownEvent");
require("./vendor/shim-keyboard-event-key");
var KEY_SEQUENCE_TIMEOUT = 1000;
var ESCAPE_HATCH_KEY = "*";
var useHotkeys = function (hotkeys, callback, options) {
    var hotkeysArray = (0, react_1.useMemo)(function () {
        return Array.isArray(hotkeys)
            ? hotkeys.map(getHotkeysArray_1.default)
            : [(0, getHotkeysArray_1.default)(hotkeys)];
    }, [hotkeys]);
    (0, react_1.useEffect)(function () {
        var keySequences = {};
        var sequenceTimers = {};
        var _a = options || {}, enabled = _a.enabled, enableOnContentEditable = _a.enableOnContentEditable, ignoredElementWhitelist = _a.ignoredElementWhitelist, eventListenerOptions = _a.eventListenerOptions;
        var clearSequenceTimer = function (index) {
            clearTimeout(sequenceTimers[index]);
        };
        var resetKeySequence = function (index) {
            clearSequenceTimer(index);
            keySequences[index] = [];
        };
        var handleKeySequence = function (event, keys, index) {
            clearSequenceTimer(index);
            keySequences[index] = keySequences[index] || [];
            sequenceTimers[index] = window.setTimeout(function () {
                resetKeySequence(index);
            }, KEY_SEQUENCE_TIMEOUT);
            var keySequence = keySequences[index];
            keySequence.push(event.key.toLowerCase());
            if ((0, arraysAreEqual_1.default)(keySequence, keys)) {
                resetKeySequence(index);
                callback(event);
            }
        };
        var handleModifierCombo = function (event, keys) {
            var actionKey = (0, tail_1.default)(keys);
            var modKeys = (0, mapModifierKeys_1.default)((0, takeUntilLast_1.default)(keys));
            var activeModKeys = (0, getActiveModifierKeys_1.default)(event);
            var allModKeysPressed = (0, isSameSet_1.default)(modKeys, activeModKeys);
            if (allModKeysPressed && event.key.toLowerCase() === actionKey) {
                callback(event);
            }
        };
        var onKeydown = function (event) {
            if ((0, ignoreKeydownEvent_1.default)(event, enableOnContentEditable, ignoredElementWhitelist)) {
                return;
            }
            hotkeysArray.forEach(function (keysArray, i) {
                if (keysArray.length === 1 && keysArray[0] === ESCAPE_HATCH_KEY) {
                    /**
                     * Provide escape hatch should the user want to perform
                     * some custom logic not supported by the API.
                     */
                    callback(event);
                    return;
                }
                // Handle modifier key combos
                if ((0, modifierKeyPressed_1.default)(event)) {
                    handleModifierCombo(event, keysArray);
                    return;
                }
                // Handle key sequences
                if (keysArray.length > 1 && !(0, modifierKeyPressed_1.default)(event)) {
                    handleKeySequence(event, keysArray, i);
                    return;
                }
                // Handle the basic case; a single hotkey
                if (event.key.toLowerCase() === keysArray[0]) {
                    callback(event);
                }
            });
        };
        if (enabled !== false) {
            window.addEventListener("keydown", onKeydown, eventListenerOptions);
        }
        return function () {
            window.removeEventListener("keydown", onKeydown, eventListenerOptions);
        };
    }, [
        hotkeysArray,
        callback,
        options === null || options === void 0 ? void 0 : options.enabled,
        options === null || options === void 0 ? void 0 : options.enableOnContentEditable,
        options === null || options === void 0 ? void 0 : options.ignoredElementWhitelist,
        options === null || options === void 0 ? void 0 : options.eventListenerOptions,
    ]);
};
exports.default = useHotkeys;
